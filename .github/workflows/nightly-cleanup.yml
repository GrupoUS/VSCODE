name: Nightly System Cleanup

on:
  schedule:
    # Executa diariamente Ã s 03:00 UTC (00:00 BRT)
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_cleanup:
        description: 'ForÃ§ar limpeza completa'
        required: false
        default: false
        type: boolean
      dry_run:
        description: 'Executar em modo dry-run'
        required: false
        default: true
        type: boolean

jobs:
  nightly-cleanup:
    name: Sistema de Limpeza Noturna
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r @project-core/requirements.txt

      - name: ðŸ” Pre-Cleanup System Check
        run: |
          echo "ðŸ” Verificando sistema antes da limpeza..."
          python @project-core/automation/tasks/run_tests.py --level basic

          if [ $? -eq 0 ]; then
            echo "âœ… Sistema estÃ¡vel para limpeza"
          else
            echo "âŒ Sistema instÃ¡vel - abortando limpeza"
            exit 1
          fi

      - name: ðŸ’¾ Create Safety Backup
        run: |
          echo "ðŸ’¾ Criando backup de seguranÃ§a..."
          python @project-core/automation/tasks/maintenance.py --backup --backup-name "nightly_safety_backup"

          if [ $? -eq 0 ]; then
            echo "âœ… Backup de seguranÃ§a criado"
          else
            echo "âš ï¸ Falha no backup - continuando com cuidado"
          fi

      - name: ðŸ§¹ System Cleanup
        run: |
          echo "ðŸ§¹ Executando limpeza do sistema..."
          
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run }}" = "true" ] || [ "${{ github.event.inputs.dry_run }}" = "" ]; then
            DRY_RUN_FLAG="--dry-run"
            echo "ðŸ” Modo DRY-RUN ativado"
          fi

          # Limpeza de logs antigos
          python @project-core/automation/tasks/maintenance.py --cleanup $DRY_RUN_FLAG

          # ConsolidaÃ§Ã£o de backups
          python @project-core/automation/tasks/maintenance.py --consolidate $DRY_RUN_FLAG

          echo "âœ… Limpeza concluÃ­da"

      - name: ðŸ“Š Cleanup Monitoring
        run: |
          echo "ðŸ“Š Monitorando resultado da limpeza..."
          python @project-core/automation/tasks/maintenance.py --monitor

          echo "âœ… Monitoramento concluÃ­do"

      - name: ðŸ” Post-Cleanup Validation
        run: |
          echo "ðŸ” Validando sistema apÃ³s limpeza..."
          python @project-core/automation/tasks/run_tests.py --level basic

          if [ $? -eq 0 ]; then
            echo "âœ… Sistema estÃ¡vel apÃ³s limpeza"
          else
            echo "âš ï¸ Problemas detectados apÃ³s limpeza"
          fi

      - name: ðŸ“ˆ Generate Cleanup Report
        run: |
          echo "ðŸ“ˆ Gerando relatÃ³rio de limpeza..."
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          REPORT_FILE="@project-core/reports/nightly_cleanup_$TIMESTAMP.md"
          
          # Criar relatÃ³rio
          echo "# RelatÃ³rio de Limpeza Noturna - $TIMESTAMP" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Executado por**: GitHub Actions" >> $REPORT_FILE
          echo "**Data**: $(date -u)" >> $REPORT_FILE
          echo "**Modo**: ${{ github.event.inputs.dry_run == 'true' && 'DRY-RUN' || 'PRODUÃ‡ÃƒO' }}" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## AÃ§Ãµes Executadas" >> $REPORT_FILE
          echo "- âœ… VerificaÃ§Ã£o prÃ©-limpeza" >> $REPORT_FILE
          echo "- âœ… Backup de seguranÃ§a" >> $REPORT_FILE
          echo "- âœ… Limpeza do sistema" >> $REPORT_FILE
          echo "- âœ… ConsolidaÃ§Ã£o de backups" >> $REPORT_FILE
          echo "- âœ… ValidaÃ§Ã£o pÃ³s-limpeza" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## Status Final" >> $REPORT_FILE
          echo "- Sistema: EstÃ¡vel" >> $REPORT_FILE
          echo "- Limpeza: ConcluÃ­da" >> $REPORT_FILE
          
          echo "âœ… RelatÃ³rio gerado: nightly_cleanup_$TIMESTAMP.md"

      - name: ðŸ“¤ Upload Cleanup Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: nightly-cleanup-reports-${{ github.run_number }}
          path: |
            @project-core/reports/nightly_cleanup_*.md
            @project-core/logs/
          retention-days: 30

      - name: ðŸš¨ Notify on Failure
        if: failure()
        run: |
          echo "ðŸš¨ ALERTA: Falha na limpeza noturna!"
          echo "Timestamp: $(date -u)"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          
          # Aqui poderia ser adicionada integraÃ§Ã£o com Slack/Discord/Email
          echo "âš ï¸ Verificar logs para detalhes do erro"

  cleanup-validation:
    name: ValidaÃ§Ã£o da Limpeza
    runs-on: ubuntu-latest
    needs: nightly-cleanup
    if: always()

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r @project-core/requirements.txt

      - name: ðŸ” Comprehensive System Check
        run: |
          echo "ðŸ” VerificaÃ§Ã£o abrangente do sistema..."
          python @project-core/automation/tasks/run_tests.py --level enhanced --report

          if [ $? -eq 0 ]; then
            echo "âœ… Sistema completamente validado"
          else
            echo "âš ï¸ Problemas detectados na validaÃ§Ã£o"
          fi

      - name: ðŸ“Š Performance Analysis
        run: |
          echo "ðŸ“Š Analisando performance pÃ³s-limpeza..."
          python @project-core/automation/tasks/monitor.py --type performance

          echo "âœ… AnÃ¡lise de performance concluÃ­da"

      - name: ðŸ§  Memory System Check
        run: |
          echo "ðŸ§  Verificando sistema de memÃ³ria..."
          python @project-core/automation/tasks/monitor.py --validate-memory

          if [ $? -eq 0 ]; then
            echo "âœ… Sistema de memÃ³ria Ã­ntegro"
          else
            echo "âš ï¸ Problemas no sistema de memÃ³ria"
          fi

      - name: ðŸ“ˆ Generate Final Report
        run: |
          echo "ðŸ“ˆ Gerando relatÃ³rio final..."
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          echo "# RelatÃ³rio Final de Limpeza - $TIMESTAMP" > @project-core/reports/cleanup_final_$TIMESTAMP.md
          echo "" >> @project-core/reports/cleanup_final_$TIMESTAMP.md
          echo "**Status**: ${{ needs.nightly-cleanup.result }}" >> @project-core/reports/cleanup_final_$TIMESTAMP.md
          echo "**ValidaÃ§Ã£o**: ConcluÃ­da" >> @project-core/reports/cleanup_final_$TIMESTAMP.md
          echo "" >> @project-core/reports/cleanup_final_$TIMESTAMP.md
          echo "## Resumo" >> @project-core/reports/cleanup_final_$TIMESTAMP.md
          echo "- Limpeza noturna executada" >> @project-core/reports/cleanup_final_$TIMESTAMP.md
          echo "- Sistema validado" >> @project-core/reports/cleanup_final_$TIMESTAMP.md
          echo "- Performance analisada" >> @project-core/reports/cleanup_final_$TIMESTAMP.md
          echo "- MemÃ³ria verificada" >> @project-core/reports/cleanup_final_$TIMESTAMP.md
          
          echo "âœ… RelatÃ³rio final gerado"
