name: VIBECODE Automation V4.0

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Executa diariamente Ã s 02:00 UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      comprehensive_test:
        description: "Executar testes abrangentes"
        required: false
        default: false
        type: boolean
      cleanup_system:
        description: "Executar limpeza do sistema"
        required: false
        default: false
        type: boolean

jobs:
  vibecode-validation:
    name: VIBECODE System Validation
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r @project-core/requirements.txt

      - name: ðŸ—ï¸ Structure Validation
        run: |
          echo "ðŸ§  VIBECODE SYSTEM V4.0 - Structure Validation"
          python @project-core/automation/tasks/monitor.py --type structure

          if [ $? -eq 0 ]; then
            echo "âœ… Estrutura validada com sucesso"
          else
            echo "âŒ Falha na validaÃ§Ã£o de estrutura"
            exit 1
          fi

      - name: ðŸ¥ System Health Check
        run: |
          echo "ðŸ¥ Verificando saÃºde do sistema..."
          python @project-core/automation/tasks/monitor.py --type performance

          if [ $? -eq 0 ]; then
            echo "âœ… Sistema saudÃ¡vel"
          else
            echo "âš ï¸ Problemas de saÃºde detectados"
          fi

      - name: ðŸ“‹ Memory Validation
        run: |
          echo "ðŸ§  Verificando sistema de memÃ³ria..."
          python @project-core/automation/tasks/monitor.py --validate-memory

          if [ $? -eq 0 ]; then
            echo "âœ… Sistema de memÃ³ria OK"
          else
            echo "âŒ Problemas no sistema de memÃ³ria"
            exit 1
          fi

      - name: ðŸ§ª Comprehensive Test Suite
        run: |
          echo "ðŸš€ Executando suite de testes..."

          if [ "${{ github.event.inputs.comprehensive_test }}" = "true" ]; then
            python @project-core/automation/tasks/run_tests.py --level comprehensive --backup-protection --memory-validation --report
          else
            python @project-core/automation/tasks/run_tests.py --level enhanced --report
          fi

          if [ $? -eq 0 ]; then
            echo "âœ… Testes passaram"
          else
            echo "âŒ Testes falharam"
            exit 1
          fi

      - name: ðŸ§¹ System Cleanup (Optional)
        if: github.event.inputs.cleanup_system == 'true'
        run: |
          echo "ðŸ§¹ Executando limpeza do sistema..."
          python @project-core/automation/tasks/maintenance.py --cleanup --dry-run

          echo "âœ… Limpeza concluÃ­da (dry-run)"

      - name: ðŸ“Š Generate Reports
        run: |
          echo "ðŸ“Š Gerando relatÃ³rios..."

          # Criar diretÃ³rio de relatÃ³rios se nÃ£o existir
          mkdir -p @project-core/reports

          # AnÃ¡lise de mÃ©tricas de aprendizado
          python @project-core/automation/tasks/monitor.py --learning-metrics

          # Escanear oportunidades de otimizaÃ§Ã£o
          python @project-core/automation/tasks/monitor.py --scan-optimization

          echo "âœ… RelatÃ³rios gerados"

      - name: ðŸ“¤ Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vibecode-reports-${{ github.run_number }}
          path: |
            @project-core/reports/
            @project-core/logs/
          retention-days: 30

  sync-validation:
    name: Repository Sync Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r @project-core/requirements.txt

      - name: ðŸ”„ Validate Sync Status
        run: |
          echo "ðŸ” Validando status de sincronizaÃ§Ã£o..."
          python @project-core/automation/tasks/sync.py --status

          if [ $? -eq 0 ]; then
            echo "âœ… SincronizaÃ§Ã£o validada"
          else
            echo "âš ï¸ Problemas de sincronizaÃ§Ã£o detectados"
          fi

      - name: ðŸ” Monitor Sync Health
        run: |
          echo "ðŸ” Monitorando saÃºde da sincronizaÃ§Ã£o..."
          python @project-core/automation/tasks/monitor.py --type sync

          if [ $? -eq 0 ]; then
            echo "âœ… SincronizaÃ§Ã£o saudÃ¡vel"
          else
            echo "âš ï¸ Problemas de sincronizaÃ§Ã£o detectados"
          fi

  learning-optimization:
    name: Learning System Optimization
    runs-on: ubuntu-latest
    if: github.event.schedule

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r @project-core/requirements.txt

      - name: ðŸ§  Learning Metrics Analysis
        run: |
          echo "ðŸ§  Analisando mÃ©tricas de aprendizado..."
          python @project-core/automation/tasks/monitor.py --learning-metrics

          echo "âœ… AnÃ¡lise de mÃ©tricas concluÃ­da"

      - name: ðŸ” Scan Optimization Opportunities
        run: |
          echo "ðŸ” Escaneando oportunidades de otimizaÃ§Ã£o..."
          python @project-core/automation/tasks/monitor.py --scan-optimization

          echo "âœ… Escaneamento concluÃ­do"

      - name: âš¡ Execute Safe Optimizations
        run: |
          echo "âš¡ Executando otimizaÃ§Ãµes seguras..."

          # Limpeza segura com dry-run
          python @project-core/automation/tasks/maintenance.py --cleanup --dry-run
          python @project-core/automation/tasks/maintenance.py --consolidate --dry-run

          echo "âœ… OtimizaÃ§Ãµes seguras executadas (dry-run)"

      - name: ðŸ“ˆ Generate Learning Report
        run: |
          echo "ðŸ“ˆ Gerando relatÃ³rio de aprendizado..."

          # Criar timestamp para o relatÃ³rio
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Criar relatÃ³rio consolidado
          echo "# RelatÃ³rio de Aprendizado - $TIMESTAMP" > @project-core/reports/learning_report_$TIMESTAMP.md
          echo "" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "**Gerado por**: GitHub Actions" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "**Data**: $(date -u)" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "## Status do Sistema" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "- âœ… Sistema de aprendizado ativo" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "- âœ… MÃ©tricas analisadas" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "- âœ… Oportunidades identificadas" >> @project-core/reports/learning_report_$TIMESTAMP.md

          echo "âœ… RelatÃ³rio gerado: learning_report_$TIMESTAMP.md"

      - name: ðŸ“¤ Upload Learning Reports
        uses: actions/upload-artifact@v4
        with:
          name: learning-reports-${{ github.run_number }}
          path: "@project-core/reports/learning_report_*.md"
          retention-days: 90
