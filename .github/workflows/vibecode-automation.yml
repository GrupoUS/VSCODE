name: VIBECODE Automation V4.0

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Executa diariamente às 02:00 UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      comprehensive_test:
        description: "Executar testes abrangentes"
        required: false
        default: false
        type: boolean
      cleanup_system:
        description: "Executar limpeza do sistema"
        required: false
        default: false
        type: boolean

jobs:
  vibecode-validation:
    name: VIBECODE System Validation
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: 📦 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r @project-core/requirements.txt

      - name: 🏗️ Structure Validation
        run: |
          echo "🧠 VIBECODE SYSTEM V4.0 - Structure Validation"
          python @project-core/automation/tasks/monitor.py --type structure

          if [ $? -eq 0 ]; then
            echo "✅ Estrutura validada com sucesso"
          else
            echo "❌ Falha na validação de estrutura"
            exit 1
          fi

      - name: 🏥 System Health Check
        run: |
          echo "🏥 Verificando saúde do sistema..."
          python @project-core/automation/tasks/monitor.py --type performance

          if [ $? -eq 0 ]; then
            echo "✅ Sistema saudável"
          else
            echo "⚠️ Problemas de saúde detectados"
          fi

      - name: 📋 Memory Validation
        run: |
          echo "🧠 Verificando sistema de memória..."
          python @project-core/automation/tasks/monitor.py --validate-memory

          if [ $? -eq 0 ]; then
            echo "✅ Sistema de memória OK"
          else
            echo "❌ Problemas no sistema de memória"
            exit 1
          fi

      - name: 🧪 Comprehensive Test Suite
        run: |
          echo "🚀 Executando suite de testes..."

          if [ "${{ github.event.inputs.comprehensive_test }}" = "true" ]; then
            python @project-core/automation/tasks/run_tests.py --level comprehensive --backup-protection --memory-validation --report
          else
            python @project-core/automation/tasks/run_tests.py --level enhanced --report
          fi

          if [ $? -eq 0 ]; then
            echo "✅ Testes passaram"
          else
            echo "❌ Testes falharam"
            exit 1
          fi

      - name: 🧹 System Cleanup (Optional)
        if: github.event.inputs.cleanup_system == 'true'
        run: |
          echo "🧹 Executando limpeza do sistema..."
          python @project-core/automation/tasks/maintenance.py --cleanup --dry-run

          echo "✅ Limpeza concluída (dry-run)"

      - name: 📊 Generate Reports
        run: |
          echo "📊 Gerando relatórios..."

          # Criar diretório de relatórios se não existir
          mkdir -p @project-core/reports

          # Análise de métricas de aprendizado
          python @project-core/automation/tasks/monitor.py --learning-metrics

          # Escanear oportunidades de otimização
          python @project-core/automation/tasks/monitor.py --scan-optimization

          echo "✅ Relatórios gerados"

      - name: 📤 Upload Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vibecode-reports-${{ github.run_number }}
          path: |
            @project-core/reports/
            @project-core/logs/
          retention-days: 30

  sync-validation:
    name: Repository Sync Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r @project-core/requirements.txt

      - name: 🔄 Validate Sync Status
        run: |
          echo "🔍 Validando status de sincronização..."
          python @project-core/automation/tasks/sync.py --status

          if [ $? -eq 0 ]; then
            echo "✅ Sincronização validada"
          else
            echo "⚠️ Problemas de sincronização detectados"
          fi

      - name: 🔍 Monitor Sync Health
        run: |
          echo "🔍 Monitorando saúde da sincronização..."
          python @project-core/automation/tasks/monitor.py --type sync

          if [ $? -eq 0 ]; then
            echo "✅ Sincronização saudável"
          else
            echo "⚠️ Problemas de sincronização detectados"
          fi

  learning-optimization:
    name: Learning System Optimization
    runs-on: ubuntu-latest
    if: github.event.schedule

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v4

      - name: 🐍 Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 📦 Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r @project-core/requirements.txt

      - name: 🧠 Learning Metrics Analysis
        run: |
          echo "🧠 Analisando métricas de aprendizado..."
          python @project-core/automation/tasks/monitor.py --learning-metrics

          echo "✅ Análise de métricas concluída"

      - name: 🔍 Scan Optimization Opportunities
        run: |
          echo "🔍 Escaneando oportunidades de otimização..."
          python @project-core/automation/tasks/monitor.py --scan-optimization

          echo "✅ Escaneamento concluído"

      - name: ⚡ Execute Safe Optimizations
        run: |
          echo "⚡ Executando otimizações seguras..."

          # Limpeza segura com dry-run
          python @project-core/automation/tasks/maintenance.py --cleanup --dry-run
          python @project-core/automation/tasks/maintenance.py --consolidate --dry-run

          echo "✅ Otimizações seguras executadas (dry-run)"

      - name: 📈 Generate Learning Report
        run: |
          echo "📈 Gerando relatório de aprendizado..."

          # Criar timestamp para o relatório
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)

          # Criar relatório consolidado
          echo "# Relatório de Aprendizado - $TIMESTAMP" > @project-core/reports/learning_report_$TIMESTAMP.md
          echo "" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "**Gerado por**: GitHub Actions" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "**Data**: $(date -u)" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "## Status do Sistema" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "- ✅ Sistema de aprendizado ativo" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "- ✅ Métricas analisadas" >> @project-core/reports/learning_report_$TIMESTAMP.md
          echo "- ✅ Oportunidades identificadas" >> @project-core/reports/learning_report_$TIMESTAMP.md

          echo "✅ Relatório gerado: learning_report_$TIMESTAMP.md"

      - name: 📤 Upload Learning Reports
        uses: actions/upload-artifact@v4
        with:
          name: learning-reports-${{ github.run_number }}
          path: "@project-core/reports/learning_report_*.md"
          retention-days: 90
