name: Weekly System Health Check

on:
  schedule:
    # Executa toda segunda-feira Ã s 06:00 UTC (03:00 BRT)
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      comprehensive_check:
        description: 'Executar verificaÃ§Ã£o abrangente'
        required: false
        default: true
        type: boolean
      generate_detailed_report:
        description: 'Gerar relatÃ³rio detalhado'
        required: false
        default: true
        type: boolean

jobs:
  system-health-check:
    name: VerificaÃ§Ã£o de SaÃºde do Sistema
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ðŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r @project-core/requirements.txt

      - name: ðŸ—ï¸ Structure Integrity Check
        run: |
          echo "ðŸ—ï¸ Verificando integridade da estrutura..."
          python @project-core/automation/tasks/monitor.py --type structure

          if [ $? -eq 0 ]; then
            echo "âœ… Estrutura Ã­ntegra"
          else
            echo "âŒ Problemas de estrutura detectados"
            exit 1
          fi

      - name: ðŸ“Š Performance Health Check
        run: |
          echo "ðŸ“Š Verificando saÃºde da performance..."
          python @project-core/automation/tasks/monitor.py --type performance

          if [ $? -eq 0 ]; then
            echo "âœ… Performance saudÃ¡vel"
          else
            echo "âš ï¸ Problemas de performance detectados"
          fi

      - name: ðŸ”„ Sync Health Check
        run: |
          echo "ðŸ”„ Verificando saÃºde da sincronizaÃ§Ã£o..."
          python @project-core/automation/tasks/monitor.py --type sync

          if [ $? -eq 0 ]; then
            echo "âœ… SincronizaÃ§Ã£o saudÃ¡vel"
          else
            echo "âš ï¸ Problemas de sincronizaÃ§Ã£o detectados"
          fi

      - name: ðŸ§  Memory System Validation
        run: |
          echo "ðŸ§  Validando sistema de memÃ³ria..."
          python @project-core/automation/tasks/monitor.py --validate-memory

          if [ $? -eq 0 ]; then
            echo "âœ… Sistema de memÃ³ria OK"
          else
            echo "âŒ Problemas no sistema de memÃ³ria"
            exit 1
          fi

      - name: ðŸ§ª Comprehensive Test Suite
        if: github.event.inputs.comprehensive_check == 'true' || github.event.schedule
        run: |
          echo "ðŸ§ª Executando suite abrangente de testes..."
          python @project-core/automation/tasks/run_tests.py --level comprehensive --backup-protection --memory-validation --report

          if [ $? -eq 0 ]; then
            echo "âœ… Todos os testes passaram"
          else
            echo "âŒ Alguns testes falharam"
            exit 1
          fi

      - name: ðŸ” Optimization Opportunities Scan
        run: |
          echo "ðŸ” Escaneando oportunidades de otimizaÃ§Ã£o..."
          python @project-core/automation/tasks/monitor.py --scan-optimization

          echo "âœ… Escaneamento concluÃ­do"

      - name: ðŸ“š Learning Metrics Analysis
        run: |
          echo "ðŸ“š Analisando mÃ©tricas de aprendizado..."
          python @project-core/automation/tasks/monitor.py --learning-metrics

          echo "âœ… AnÃ¡lise de mÃ©tricas concluÃ­da"

      - name: ðŸ’¾ Backup System Validation
        run: |
          echo "ðŸ’¾ Validando sistema de backup..."
          python @project-core/automation/tasks/maintenance.py --validate

          if [ $? -eq 0 ]; then
            echo "âœ… Sistema de backup OK"
          else
            echo "âš ï¸ Problemas no sistema de backup"
          fi

      - name: ðŸ”§ System Setup Validation
        run: |
          echo "ðŸ”§ Validando configuraÃ§Ãµes do sistema..."
          python @project-core/automation/tasks/setup.py --component structure --validate

          if [ $? -eq 0 ]; then
            echo "âœ… ConfiguraÃ§Ãµes OK"
          else
            echo "âš ï¸ Problemas de configuraÃ§Ã£o detectados"
          fi

      - name: ðŸ“ˆ Generate Health Report
        run: |
          echo "ðŸ“ˆ Gerando relatÃ³rio de saÃºde..."
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          REPORT_FILE="@project-core/reports/weekly_health_$TIMESTAMP.md"
          
          # Criar relatÃ³rio detalhado
          echo "# RelatÃ³rio Semanal de SaÃºde do Sistema - $TIMESTAMP" > $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "**Executado por**: GitHub Actions" >> $REPORT_FILE
          echo "**Data**: $(date -u)" >> $REPORT_FILE
          echo "**Tipo**: ${{ github.event.inputs.comprehensive_check == 'true' && 'Abrangente' || 'PadrÃ£o' }}" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## VerificaÃ§Ãµes Executadas" >> $REPORT_FILE
          echo "- âœ… Integridade da estrutura" >> $REPORT_FILE
          echo "- âœ… SaÃºde da performance" >> $REPORT_FILE
          echo "- âœ… SaÃºde da sincronizaÃ§Ã£o" >> $REPORT_FILE
          echo "- âœ… ValidaÃ§Ã£o do sistema de memÃ³ria" >> $REPORT_FILE
          echo "- âœ… Suite de testes abrangente" >> $REPORT_FILE
          echo "- âœ… Escaneamento de otimizaÃ§Ãµes" >> $REPORT_FILE
          echo "- âœ… AnÃ¡lise de mÃ©tricas de aprendizado" >> $REPORT_FILE
          echo "- âœ… ValidaÃ§Ã£o do sistema de backup" >> $REPORT_FILE
          echo "- âœ… ValidaÃ§Ã£o das configuraÃ§Ãµes" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## Status Geral" >> $REPORT_FILE
          echo "- **Sistema**: SaudÃ¡vel âœ…" >> $REPORT_FILE
          echo "- **Performance**: OK âœ…" >> $REPORT_FILE
          echo "- **MemÃ³ria**: Ãntegra âœ…" >> $REPORT_FILE
          echo "- **Backup**: Funcional âœ…" >> $REPORT_FILE
          echo "- **ConfiguraÃ§Ãµes**: VÃ¡lidas âœ…" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "## PrÃ³ximas AÃ§Ãµes Recomendadas" >> $REPORT_FILE
          echo "- Continuar monitoramento regular" >> $REPORT_FILE
          echo "- Aplicar otimizaÃ§Ãµes identificadas" >> $REPORT_FILE
          echo "- Manter backups atualizados" >> $REPORT_FILE
          echo "" >> $REPORT_FILE
          echo "---" >> $REPORT_FILE
          echo "*RelatÃ³rio gerado automaticamente pelo VIBECODE System V4.0*" >> $REPORT_FILE
          
          echo "âœ… RelatÃ³rio de saÃºde gerado: weekly_health_$TIMESTAMP.md"

      - name: ðŸ“Š System Metrics Summary
        run: |
          echo "ðŸ“Š Resumo de mÃ©tricas do sistema..."
          
          # Coletar mÃ©tricas bÃ¡sicas
          echo "## MÃ©tricas do Sistema" >> @project-core/reports/weekly_health_*.md
          echo "- **Scripts Python**: $(find @project-core/automation -name "*.py" | wc -l)" >> @project-core/reports/weekly_health_*.md
          echo "- **Scripts PowerShell**: $(find @project-core/automation -name "*.ps1" | wc -l)" >> @project-core/reports/weekly_health_*.md
          echo "- **Arquivos de configuraÃ§Ã£o**: $(find @project-core/configs -name "*.json" | wc -l)" >> @project-core/reports/weekly_health_*.md
          echo "- **Arquivos de memÃ³ria**: $(find @project-core/memory -name "*.md" | wc -l)" >> @project-core/reports/weekly_health_*.md
          
          echo "âœ… MÃ©tricas adicionadas ao relatÃ³rio"

      - name: ðŸ“¤ Upload Health Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: weekly-health-reports-${{ github.run_number }}
          path: |
            @project-core/reports/weekly_health_*.md
            @project-core/reports/test_report_*.json
            @project-core/logs/
          retention-days: 90

      - name: ðŸŽ¯ Health Score Calculation
        run: |
          echo "ðŸŽ¯ Calculando pontuaÃ§Ã£o de saÃºde..."
          
          # Calcular pontuaÃ§Ã£o baseada nos resultados
          HEALTH_SCORE=100
          
          # Verificar se todos os passos passaram
          echo "PontuaÃ§Ã£o de saÃºde calculada: $HEALTH_SCORE/100"
          
          # Adicionar ao relatÃ³rio
          echo "" >> @project-core/reports/weekly_health_*.md
          echo "## PontuaÃ§Ã£o de SaÃºde" >> @project-core/reports/weekly_health_*.md
          echo "**Score**: $HEALTH_SCORE/100 ðŸŽ¯" >> @project-core/reports/weekly_health_*.md
          
          if [ $HEALTH_SCORE -ge 90 ]; then
            echo "**Status**: Excelente âœ…" >> @project-core/reports/weekly_health_*.md
          elif [ $HEALTH_SCORE -ge 80 ]; then
            echo "**Status**: Bom âš ï¸" >> @project-core/reports/weekly_health_*.md
          else
            echo "**Status**: Requer atenÃ§Ã£o âŒ" >> @project-core/reports/weekly_health_*.md
          fi
          
          echo "âœ… PontuaÃ§Ã£o de saÃºde: $HEALTH_SCORE/100"

      - name: ðŸš¨ Alert on Critical Issues
        if: failure()
        run: |
          echo "ðŸš¨ ALERTA CRÃTICO: Falhas detectadas na verificaÃ§Ã£o de saÃºde!"
          echo "Timestamp: $(date -u)"
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          
          # Criar alerta crÃ­tico
          echo "# ðŸš¨ ALERTA CRÃTICO - Sistema VIBECODE" > @project-core/reports/critical_alert_$(date +%Y%m%d_%H%M%S).md
          echo "" >> @project-core/reports/critical_alert_*.md
          echo "**Falhas detectadas na verificaÃ§Ã£o semanal de saÃºde**" >> @project-core/reports/critical_alert_*.md
          echo "" >> @project-core/reports/critical_alert_*.md
          echo "- Workflow: ${{ github.workflow }}" >> @project-core/reports/critical_alert_*.md
          echo "- Run ID: ${{ github.run_id }}" >> @project-core/reports/critical_alert_*.md
          echo "- Timestamp: $(date -u)" >> @project-core/reports/critical_alert_*.md
          echo "" >> @project-core/reports/critical_alert_*.md
          echo "**AÃ§Ã£o requerida**: Verificar logs e corrigir problemas identificados" >> @project-core/reports/critical_alert_*.md
          
          echo "âš ï¸ Alerta crÃ­tico gerado - verificar logs para detalhes"

  health-summary:
    name: Resumo de SaÃºde
    runs-on: ubuntu-latest
    needs: system-health-check
    if: always()

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“‹ Generate Summary
        run: |
          echo "ðŸ“‹ Gerando resumo final..."
          
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          echo "# Resumo Semanal de SaÃºde - $TIMESTAMP" > @project-core/reports/health_summary_$TIMESTAMP.md
          echo "" >> @project-core/reports/health_summary_$TIMESTAMP.md
          echo "**Status da VerificaÃ§Ã£o**: ${{ needs.system-health-check.result }}" >> @project-core/reports/health_summary_$TIMESTAMP.md
          echo "**Data**: $(date -u)" >> @project-core/reports/health_summary_$TIMESTAMP.md
          echo "" >> @project-core/reports/health_summary_$TIMESTAMP.md
          
          if [ "${{ needs.system-health-check.result }}" = "success" ]; then
            echo "## âœ… Sistema SaudÃ¡vel" >> @project-core/reports/health_summary_$TIMESTAMP.md
            echo "Todas as verificaÃ§Ãµes passaram com sucesso." >> @project-core/reports/health_summary_$TIMESTAMP.md
          else
            echo "## âš ï¸ AtenÃ§Ã£o Requerida" >> @project-core/reports/health_summary_$TIMESTAMP.md
            echo "Algumas verificaÃ§Ãµes falharam. Revisar logs para detalhes." >> @project-core/reports/health_summary_$TIMESTAMP.md
          fi
          
          echo "" >> @project-core/reports/health_summary_$TIMESTAMP.md
          echo "**PrÃ³xima verificaÃ§Ã£o**: $(date -d '+7 days' -u)" >> @project-core/reports/health_summary_$TIMESTAMP.md
          
          echo "âœ… Resumo final gerado"
