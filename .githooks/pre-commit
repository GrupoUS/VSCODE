#!/bin/bash
# GRUPO US VIBECODE SYSTEM V4.0 - Pre-Commit Security Hook

echo "üöÄ Executando verifica√ß√£o de seguran√ßa pr√©-commit..."

# Padr√µes de regex para secrets comuns
FORBIDDEN_PATTERNS=(
    "api_key"
    "secret"
    "token"
    "password"
    "sk_live_"
    "pk_live_"
    "ghp_"
    "AKIA[0-9A-Z]{16}"
    "-----BEGIN (RSA|DSA|EC|OPENSSH) PRIVATE KEY-----"
    "-----BEGIN CERTIFICATE-----"
)

# Arquivos a serem ignorados na verifica√ß√£o
IGNORED_FILES=(
    ".githooks/pre-commit"
    ".gitignore"
    "package.json"
    "README.md"
    ".env.example"
    "setup_git_secrets.py"
)

HAS_SECRET=0

for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
    # Procura por secrets nos arquivos em staged
    MATCHES=$(git diff --staged --name-only -z | xargs -0 grep -l -i -E "$pattern" | grep -vFf <(printf "%s\n" "${IGNORED_FILES[@]}"))

    if [ -n "$MATCHES" ]; then
        echo "‚ùå ERRO: Secret potencial encontrado no(s) arquivo(s) abaixo:"
        echo "$MATCHES"
        echo "Padr√£o detectado: '$pattern'"
        HAS_SECRET=1
    fi
done

if [ $HAS_SECRET -eq 1 ]; then
    echo "üõë Commit bloqueado. Remova os secrets antes de continuar."
    echo "üí° Dica: Use vari√°veis de ambiente e o arquivo .env para secrets."
    exit 1
fi

echo "‚úÖ Verifica√ß√£o de seguran√ßa conclu√≠da. Nenhum secret encontrado."
exit 0
